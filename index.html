<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ارسم وخمن - لعبة الرسم والتخمين أونلاين</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .game-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .game-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-status {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .current-player, .timer, .round-info, .room-info {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .timer {
            color: #e74c3c;
            font-size: 1.3rem;
        }

        .room-info {
            color: #2ecc71;
        }

        .main-game {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .drawing-area {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .word-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .drawing-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .tool-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .color-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-btn.active {
            border-color: #333;
            transform: scale(1.2);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .clear-btn {
            background: #e74c3c;
            color: white;
        }

        .clear-btn:hover {
            background: #c0392b;
        }

        .brush-size {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .brush-size input {
            width: 80px;
        }

        #drawingCanvas {
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
            background: white;
            touch-action: none;
        }

        .game-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .players-list, .chat-area, .room-settings {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .players-list h3, .chat-area h3, .room-settings h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .player-item.current {
            background: #3498db;
            color: white;
            transform: scale(1.02);
        }

        .player-item.drawing {
            background: #e3f2fd;
        }

        .player-score {
            font-weight: bold;
            background: #2ecc71;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 15px;
            max-width: 90%;
            word-break: break-word;
        }

        .message.guess {
            background: #e3f2fd;
            color: #1976d2;
        }

        .message.correct {
            background: #4caf50;
            color: white;
            font-weight: bold;
        }

        .message.system {
            background: #fff3e0;
            color: #f57c00;
            text-align: center;
            font-style: italic;
        }

        .message.notification {
            background: #f3e5f5;
            color: #9c27b0;
            text-align: center;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        #guessInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        #guessInput:focus {
            outline: none;
            border-color: #3498db;
        }

        .guess-btn {
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .guess-btn:hover {
            background: #2980b9;
        }

        .setup-screen {
            text-align: center;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            margin: 50px auto;
        }

        .setup-screen h2 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: right;
        }

        .start-btn {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .game-over {
            text-align: center;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 40px;
            margin: 20px 0;
        }

        .winner {
            font-size: 2rem;
            color: #f39c12;
            margin-bottom: 20px;
        }

        .room-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .copy-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #2980b9;
        }

        .share-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .share-btn:hover {
            background: #27ae60;
        }

        .rooms-list {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .room-item:hover {
            background: #e9ecef;
        }

        .room-players {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .join-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .join-btn:hover {
            background: #2980b9;
        }

        .room-full {
            background: #f8d7da;
            color: #721c24;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid #3498db;
            color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .language-switcher {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            gap: 10px;
        }

        .language-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .language-btn.active {
            background: #3498db;
            color: white;
        }

        @media (max-width: 768px) {
            .main-game {
                grid-template-columns: 1fr;
            }
            
            .game-status {
                flex-direction: column;
                text-align: center;
            }
            
            #drawingCanvas {
                width: 100%;
                height: auto;
            }

            .language-switcher {
                position: static;
                margin: 0 auto 20px;
                justify-content: center;
                width: fit-content;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-switcher">
            <button class="language-btn active" onclick="changeLanguage('ar')">العربية</button>
            <button class="language-btn" onclick="changeLanguage('en')">English</button>
        </div>

        <div class="game-header">
            <h1>🎨 ارسم وخمن 🎨</h1>
            <p>لعبة الرسم والتخمين الممتعة أونلاين</p>
        </div>

        <!-- شاشة اختيار الغرفة -->
        <div id="roomScreen" class="setup-screen">
            <h2>اختر غرفة للعب</h2>
            
            <div class="tab-container">
                <div class="tab active" onclick="switchTab('public')">الغرف العامة</div>
                <div class="tab" onclick="switchTab('private')">إنشاء غرفة خاصة</div>
            </div>
            
            <div id="publicRoomsTab" class="tab-content active">
                <div class="rooms-list">
                    <h3><i class="fas fa-users"></i> الغرف العامة المتاحة</h3>
                    <div id="publicRoomsList">
                        <p>جاري تحميل الغرف...</p>
                    </div>
                </div>
                
                <button class="start-btn" onclick="refreshRooms()"><i class="fas fa-sync-alt"></i> تحديث القائمة</button>
            </div>
            
            <div id="privateRoomsTab" class="tab-content">
                <div class="input-group">
                    <label for="privatePlayerName">اسمك:</label>
                    <input type="text" id="privatePlayerName" placeholder="أدخل اسمك هنا" maxlength="20">
                </div>
                <div class="input-group">
                    <label for="privateRoomName">اسم الغرفة:</label>
                    <input type="text" id="privateRoomName" placeholder="اختر اسمًا للغرفة" maxlength="30">
                </div>
                <div class="input-group">
                    <label for="maxPlayers">العدد الأقصى للاعبين:</label>
                    <select id="maxPlayers">
                        <option value="4">4 لاعبين</option>
                        <option value="6">6 لاعبين</option>
                        <option value="8">8 لاعبين</option>
                        <option value="10">10 لاعبين</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="totalRounds">عدد الجولات:</label>
                    <select id="totalRounds">
                        <option value="3">3 جولات</option>
                        <option value="5" selected>5 جولات</option>
                        <option value="7">7 جولات</option>
                        <option value="10">10 جولات</option>
                    </select>
                </div>
                <button class="start-btn" onclick="createPrivateRoom()"><i class="fas fa-plus"></i> إنشاء غرفة خاصة</button>
            </div>
        </div>

        <!-- شاشة انتظار الغرفة الخاصة -->
        <div id="waitingRoomScreen" class="setup-screen" style="display: none;">
            <h2>غرفتك الخاصة جاهزة!</h2>
            <p>شارك كود الغرفة مع أصدقائك للانضمام إليك</p>
            
            <div class="room-info" style="font-size: 1.5rem; margin: 20px 0;">
                <i class="fas fa-door-open"></i> اسم الغرفة: <span id="waitingRoomName"></span>
            </div>
            
            <div class="room-code" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0;">
                <h3 style="margin-bottom: 10px;">كود الغرفة:</h3>
                <div style="font-size: 2rem; font-weight: bold; letter-spacing: 3px;" id="roomCodeDisplay"></div>
            </div>
            
            <div class="room-actions">
                <button class="copy-btn" onclick="copyRoomCode()"><i class="fas fa-copy"></i> نسخ الكود</button>
                <button class="share-btn" onclick="shareRoomCode()"><i class="fas fa-share-alt"></i> مشاركة</button>
            </div>
            
            <div id="waitingPlayers" style="margin-top: 30px;">
                <h3><i class="fas fa-users"></i> اللاعبون في الغرفة:</h3>
                <div id="waitingPlayersList" style="margin-top: 15px;">
                    <p>جارٍ انتظار اللاعبين...</p>
                </div>
            </div>
            
            <button class="start-btn" id="startGameBtn" style="display: none;" onclick="startGameFromWaitingRoom()"><i class="fas fa-play"></i> بدء اللعبة</button>
        </div>

        <!-- شاشة الانضمام إلى غرفة خاصة -->
        <div id="joinPrivateScreen" class="setup-screen" style="display: none;">
            <h2>انضم إلى غرفة خاصة</h2>
            <div class="input-group">
                <label for="joinPlayerName">اسمك:</label>
                <input type="text" id="joinPlayerName" placeholder="أدخل اسمك هنا" maxlength="20">
            </div>
            <div class="input-group">
                <label for="roomCodeInput">كود الغرفة:</label>
                <input type="text" id="roomCodeInput" placeholder="أدخل كود الغرفة" maxlength="6">
            </div>
            <button class="start-btn" onclick="joinPrivateRoom()"><i class="fas fa-sign-in-alt"></i> انضم الآن</button>
            <button class="start-btn" style="background: #e74c3c; margin-top: 10px;" onclick="backToRoomSelection()"><i class="fas fa-arrow-left"></i> رجوع</button>
        </div>

        <!-- شاشة اللعب -->
        <div id="gameScreen" style="display: none;">
            <div class="game-status">
                <div class="current-player">
                    <span id="currentPlayerText">الرسام الحالي: </span>
                </div>
                <div class="timer">
                    ⏰ <span id="timer">60</span> ثانية
                </div>
                <div class="round-info">
                    الجولة <span id="currentRound">1</span> من <span id="totalRoundsDisplay">5</span>
                </div>
                <div class="room-info">
                    <i class="fas fa-door-open"></i> <span id="currentRoomName">غرفة اللعب</span>
                </div>
            </div>

            <div class="main-game">
                <div class="drawing-area">
                    <div class="word-display" id="wordDisplay">
                        انتظر بداية الجولة...
                    </div>
                    
                    <div class="drawing-tools" id="drawingTools" style="display: none;">
                        <!-- ألوان -->
                        <button class="color-btn active" data-color="#000000" style="background: #000000;"></button>
                        <button class="color-btn" data-color="#FF0000" style="background: #FF0000;"></button>
                        <button class="color-btn" data-color="#00FF00" style="background: #00FF00;"></button>
                        <button class="color-btn" data-color="#0000FF" style="background: #0000FF;"></button>
                        <button class="color-btn" data-color="#FFFF00" style="background: #FFFF00;"></button>
                        <button class="color-btn" data-color="#FF8C00" style="background: #FF8C00;"></button>
                        <button class="color-btn" data-color="#800080" style="background: #800080;"></button>
                        <button class="color-btn" data-color="#FF1493" style="background: #FF1493;"></button>
                        <button class="color-btn" data-color="#00FFFF" style="background: #00FFFF;"></button>
                        <button class="color-btn" data-color="#A52A2A" style="background: #A52A2A;"></button>
                        <button class="color-btn" data-color="#808080" style="background: #808080;"></button>
                        <button class="color-btn" data-color="#FFFFFF" style="background: #FFFFFF; border: 1px solid #ccc;"></button>
                        
                        <!-- حجم الفرشاة -->
                        <div class="brush-size">
                            <i class="fas fa-paint-brush"></i>
                            <input type="range" id="brushSize" min="1" max="20" value="3">
                            <span id="brushSizeValue">3</span>
                        </div>
                        
                        <!-- أدوات -->
                        <button class="clear-btn tool-btn" onclick="clearCanvas()"><i class="fas fa-trash"></i> مسح</button>
                    </div>

                    <canvas id="drawingCanvas" width="600" height="400"></canvas>
                </div>

                <div class="game-sidebar">
                    <div class="players-list">
                        <h3><i class="fas fa-trophy"></i> قائمة اللاعبين</h3>
                        <div id="playersList"></div>
                    </div>

                    <div class="room-settings">
                        <h3><i class="fas fa-cog"></i> إعدادات الغرفة</h3>
                        <div style="margin-bottom: 10px;">
                            <strong>كود الغرفة:</strong> <span id="gameRoomCode"></span>
                        </div>
                        <button class="copy-btn" onclick="copyRoomCode()"><i class="fas fa-copy"></i> نسخ الكود</button>
                        <button class="share-btn" style="margin-top: 10px;" onclick="shareRoomCode()"><i class="fas fa-share-alt"></i> مشاركة</button>
                    </div>

                    <div class="chat-area">
                        <h3><i class="fas fa-comments"></i> التخمينات</h3>
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="chat-input">
                            <input type="text" id="guessInput" placeholder="اكتب تخمينك هنا..." maxlength="50">
                            <button class="guess-btn" onclick="makeGuess()"><i class="fas fa-paper-plane"></i> خمن</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- شاشة نهاية اللعبة -->
        <div id="gameOverScreen" style="display: none;">
            <div class="game-over">
                <div class="winner" id="winnerText"></div>
                <div id="finalScores"></div>
                <button class="start-btn" onclick="returnToLobby()"><i class="fas fa-home"></i> العودة إلى اللوبي</button>
            </div>
        </div>
    </div>

    <!-- صوت التأثيرات -->
    <audio id="correctSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>
    <audio id="drawingSound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>
    <audio id="notificationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // بيانات اللعبة
        const gameState = {
            players: [],
            currentPlayerIndex: 0,
            currentRound: 1,
            totalRounds: 5,
            timeLeft: 60,
            currentWord: '',
            gameStarted: false,
            roundActive: false,
            timer: null,
            roomId: '',
            roomName: '',
            isPrivate: false,
            isHost: false,
            maxPlayers: 4,
            socket: null,
            language: 'ar'
        };

        // مجموعة الكلمات للرسم
        const words = [
            'بيت', 'قطة', 'شمس', 'قمر', 'سيارة', 'طائرة', 'وردة', 'شجرة',
            'كتاب', 'قلم', 'هاتف', 'كمبيوتر', 'تلفزيون', 'طاولة', 'كرسي', 'سرير',
            'تفاحة', 'موزة', 'برتقالة', 'عنب', 'فراولة', 'خبز', 'ماء', 'عصير',
            'كلب', 'أسد', 'فيل', 'زرافة', 'حصان', 'سمكة', 'طائر', 'فراشة',
            'ساعة', 'نظارات', 'مفتاح', 'باب', 'نافذة', 'مرآة', 'صندوق', 'حقيبة',
            'قطار', 'باص', 'دراجة', 'مروحية', 'سفينة', 'غواصة', 'صاروخ', 'بالون',
            'كرة', 'لعبة', 'دمية', 'طبل', 'جيتار', 'بيانو', 'كمان', 'مايك',
            'قبعة', 'حذاء', 'قميص', 'بنطلون', 'فستان', 'معطف', 'جوارب', 'قفازات',
            'مدرسة', 'مستشفى', 'مطعم', 'حديقة', 'شاطئ', 'جبل', 'نهر', 'صحراء',
            'طبيب', 'ممرضة', 'معلم', 'طالب', 'مهندس', 'شرطي', 'رجل إطفاء', 'طاهي',
            'كرة قدم', 'سلة', 'تنس', 'سباحة', 'جري', 'قفز', 'ركوب', 'تزلج',
            'بيتزا', 'هامبرغر', 'ساندويتش', 'سلطة', 'شوربة', 'معكرونة', 'أرز', 'بطاطا',
            'قهوة', 'شاي', 'حليب', 'عصير', 'مشروب غازي', 'ماء', 'كوكتيل', 'سموذي',
            'عيد ميلاد', 'زفاف', 'حفل', 'رحلة', 'إجازة', 'مهرجان', 'احتفال', 'مناسبة'
        ];

        // عناصر الصوت
        const correctSound = document.getElementById('correctSound');
        const drawingSound = document.getElementById('drawingSound');
        const notificationSound = document.getElementById('notificationSound');

        // إعداد اللوحة القماشية
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let currentColor = '#000000';
        let currentBrushSize = 3;
        let lastX = 0;
        let lastY = 0;

        // إعداد الرسم
        function setupCanvas() {
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentBrushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // بداية الرسم
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // دعم اللمس للجوال
        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', handleTouch);
        canvas.addEventListener('touchend', stopDrawing);

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            if (e.type === 'touchstart') {
                lastX = x;
                lastY = y;
                isDrawing = true;
                ctx.beginPath();
                ctx.moveTo(x, y);
            } else if (e.type === 'touchmove' && isDrawing) {
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // إرسال بيانات الرسم إلى الخادم
                if (gameState.socket && isCurrentArtist()) {
                    gameState.socket.emit('draw', {
                        roomId: gameState.roomId,
                        fromX: lastX,
                        fromY: lastY,
                        toX: x,
                        toY: y,
                        color: currentColor,
                        size: currentBrushSize
                    });
                }
                
                lastX = x;
                lastY = y;
            }
        }

        function startDrawing(e) {
            if (!canDraw()) return;
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            
            // تشغيل صوت الرسم
            drawingSound.currentTime = 0;
            drawingSound.play();
        }

        function draw(e) {
            if (!isDrawing || !canDraw()) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
            
            // إرسال بيانات الرسم إلى الخادم
            if (gameState.socket && isCurrentArtist()) {
                gameState.socket.emit('draw', {
                    roomId: gameState.roomId,
                    fromX: lastX,
                    fromY: lastY,
                    toX: x,
                    toY: y,
                    color: currentColor,
                    size: currentBrushSize
                });
            }
            
            lastX = x;
            lastY = y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function canDraw() {
            return gameState.roundActive && isCurrentArtist();
        }

        function isCurrentArtist() {
            return gameState.players[gameState.currentPlayerIndex] && 
                   gameState.players[gameState.currentPlayerIndex].id === gameState.socket.id;
        }

        // تغيير الألوان
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelector('.color-btn.active').classList.remove('active');
                this.classList.add('active');
                currentColor = this.dataset.color;
                ctx.strokeStyle = currentColor;
            });
        });

        // تغيير حجم الفرشاة
        document.getElementById('brushSize').addEventListener('input', function() {
            currentBrushSize = this.value;
            document.getElementById('brushSizeValue').textContent = currentBrushSize;
            ctx.lineWidth = currentBrushSize;
        });

        // مسح اللوحة
        function clearCanvas() {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // إرسال أمر المسح إلى الخادم
            if (gameState.socket && isCurrentArtist()) {
                gameState.socket.emit('clearCanvas', { roomId: gameState.roomId });
            }
        }

        // تبديل بين تبويبات الغرف
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'public') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('publicRoomsTab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('privateRoomsTab').classList.add('active');
            }
        }

        // تحديث قائمة الغرف العامة
        function refreshRooms() {
            if (gameState.socket) {
                gameState.socket.emit('getPublicRooms');
                addSystemMessage('جاري تحديث قائمة الغرف...');
            }
        }

        // إنشاء غرفة خاصة
        function createPrivateRoom() {
            const playerName = document.getElementById('privatePlayerName').value.trim();
            const roomName = document.getElementById('privateRoomName').value.trim();
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
            const totalRounds = parseInt(document.getElementById('totalRounds').value);
            
            if (!playerName) {
                alert('يرجى إدخال اسمك');
                return;
            }
            
            if (!roomName) {
                alert('يرجى إدخال اسم للغرفة');
                return;
            }
            
            if (!gameState.socket) {
                connectToServer();
            }
            
            gameState.socket.emit('createPrivateRoom', {
                playerName,
                roomName,
                maxPlayers,
                totalRounds
            });
        }

        // الانضمام إلى غرفة خاصة
        function joinPrivateRoom() {
            const playerName = document.getElementById('joinPlayerName').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (!playerName) {
                alert('يرجى إدخال اسمك');
                return;
            }
            
            if (!roomCode || roomCode.length !== 6) {
                alert('يرجى إدخال كود غرفة صحيح (6 أحرف)');
                return;
            }
            
            if (!gameState.socket) {
                connectToServer();
            }
            
            gameState.socket.emit('joinPrivateRoom', {
                playerName,
                roomCode
            });
        }

        // الاتصال بالخادم
        function connectToServer() {
            // تحديد عنوان الخادم بشكل ديناميكي
            const serverUrl = window.location.hostname === 'localhost' ? 
                'http://localhost:3000' : 
                'https://draw-game-server.onrender.com';
            
            gameState.socket = io(serverUrl, {
                path: '/socket.io' // المسار الافتراضي
            });
            
            // معالجة أحداث السوكيت
            gameState.socket.on('connect', () => {
                console.log('Connected to server with ID:', gameState.socket.id);
            });
            
            gameState.socket.on('publicRoomsList', (rooms) => {
                const publicRoomsList = document.getElementById('publicRoomsList');
                publicRoomsList.innerHTML = '';
                
                if (rooms.length === 0) {
                    publicRoomsList.innerHTML = '<p>لا توجد غرف عامة متاحة حالياً</p>';
                    return;
                }
                
                rooms.forEach(room => {
                    const roomItem = document.createElement('div');
                    roomItem.className = 'room-item';
                    
                    roomItem.innerHTML = `
                        <div>
                            <strong>${room.name}</strong>
                            <div class="room-players">
                                <i class="fas fa-user"></i> ${room.players.length}/${room.maxPlayers}
                            </div>
                        </div>
                        ${room.players.length < room.maxPlayers ? 
                            `<button class="join-btn" onclick="joinPublicRoom('${room.id}')"><i class="fas fa-sign-in-alt"></i> انضم</button>` : 
                            `<span class="room-full">غرفة ممتلئة</span>`}
                    `;
                    
                    publicRoomsList.appendChild(roomItem);
                });
            });
            
            gameState.socket.on('privateRoomCreated', (data) => {
                gameState.roomId = data.roomId;
                gameState.roomName = data.roomName;
                gameState.isPrivate = true;
                gameState.isHost = true;
                gameState.maxPlayers = data.maxPlayers;
                gameState.totalRounds = data.totalRounds;
                
                document.getElementById('waitingRoomName').textContent = data.roomName;
                document.getElementById('roomCodeDisplay').textContent = data.roomCode;
                
                document.getElementById('roomScreen').style.display = 'none';
                document.getElementById('waitingRoomScreen').style.display = 'block';
                
                updateWaitingPlayersList(data.players);
            });
            
            gameState.socket.on('playerJoinedWaitingRoom', (players) => {
                updateWaitingPlayersList(players);
                
                // إذا كان المضيف ووصل عدد اللاعبين إلى 2 على الأقل، يمكنه بدء اللعبة
                if (gameState.isHost && players.length >= 2) {
                    document.getElementById('startGameBtn').style.display = 'block';
                }
            });
            
            gameState.socket.on('playerLeftWaitingRoom', (players) => {
                updateWaitingPlayersList(players);
                
                // إذا قل عدد اللاعبين عن 2، إخفاء زر البدء
                if (players.length < 2) {
                    document.getElementById('startGameBtn').style.display = 'none';
                }
            });
            
            gameState.socket.on('roomNotFound', () => {
                alert('لم يتم العثور على الغرفة. يرجى التأكد من كود الغرفة.');
            });
            
            gameState.socket.on('roomFull', () => {
                alert('هذه الغرفة ممتلئة. لا يمكن الانضمام إليها حالياً.');
            });
            
            gameState.socket.on('joinedRoom', (data) => {
                if (data.isPrivate) {
                    gameState.roomId = data.roomId;
                    gameState.roomName = data.roomName;
                    gameState.isPrivate = true;
                    gameState.isHost = false;
                    gameState.maxPlayers = data.maxPlayers;
                    gameState.totalRounds = data.totalRounds;
                    
                    document.getElementById('waitingRoomName').textContent = data.roomName;
                    document.getElementById('roomCodeDisplay').textContent = data.roomCode;
                    
                    document.getElementById('joinPrivateScreen').style.display = 'none';
                    document.getElementById('waitingRoomScreen').style.display = 'block';
                    
                    updateWaitingPlayersList(data.players);
                } else {
                    // الانضمام إلى غرفة عامة
                    gameState.roomId = data.roomId;
                    gameState.roomName = data.roomName;
                    gameState.isPrivate = false;
                    gameState.isHost = false;
                    gameState.maxPlayers = data.maxPlayers;
                    gameState.totalRounds = data.totalRounds;
                    gameState.players = data.players;
                    
                    document.getElementById('roomScreen').style.display = 'none';
                    document.getElementById('gameScreen').style.display = 'block';
                    document.getElementById('currentRoomName').textContent = data.roomName;
                    document.getElementById('totalRoundsDisplay').textContent = data.totalRounds;
                    document.getElementById('gameRoomCode').textContent = data.roomCode;
                    
                    setupCanvas();
                    updatePlayersDisplay();
                    
                    if (data.gameStarted) {
                        // اللعبة بدأت بالفعل، انتظار الجولة التالية
                        addSystemMessage('لقد انضممت إلى لعبة قيد التقدم. انتظر الجولة التالية.');
                    } else {
                        // انتظار بدء اللعبة من قبل المضيف
                        addSystemMessage('تم الانضمام إلى الغرفة. انتظر بدء اللعبة من قبل المضيف.');
                    }
                }
            });
            
            gameState.socket.on('gameStarted', (data) => {
                gameState.players = data.players;
                gameState.currentRound = 1;
                
                document.getElementById('waitingRoomScreen').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'block';
                document.getElementById('currentRoomName').textContent = gameState.roomName;
                document.getElementById('totalRoundsDisplay').textContent = gameState.totalRounds;
                document.getElementById('gameRoomCode').textContent = data.roomCode;
                
                setupCanvas();
                updatePlayersDisplay();
                startNewRound();
            });
            
            gameState.socket.on('newRoundStarted', (data) => {
                gameState.currentWord = data.word;
                gameState.currentPlayerIndex = data.artistIndex;
                gameState.timeLeft = data.timeLeft;
                gameState.roundActive = true;
                
                clearCanvas();
                updateCurrentPlayerDisplay();
                updateWordDisplay();
                startTimer();
                
                // إظهار أدوات الرسم فقط للرسام الحالي
                const drawingTools = document.getElementById('drawingTools');
                drawingTools.style.display = isCurrentArtist() ? 'flex' : 'none';
                
                addSystemMessage(`بدأت جولة جديدة! ${gameState.players[gameState.currentPlayerIndex].name} يرسم الآن`);
                
                // تشغيل صوت الإشعار
                notificationSound.currentTime = 0;
                notificationSound.play();
            });
            
            gameState.socket.on('drawingData', (data) => {
                ctx.strokeStyle = data.color;
                ctx.lineWidth = data.size;
                ctx.beginPath();
                ctx.moveTo(data.fromX, data.fromY);
                ctx.lineTo(data.toX, data.toY);
                ctx.stroke();
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = currentBrushSize;
            });
            
            gameState.socket.on('canvasCleared', () => {
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            });
            
            gameState.socket.on('newMessage', (message) => {
                addMessage(message.text, message.type, message.playerName);
            });
            
            gameState.socket.on('correctGuess', (data) => {
                gameState.players = data.players;
                updatePlayersDisplay();
                endRound(true);
            });
            
            gameState.socket.on('roundEnded', (data) => {
                gameState.players = data.players;
                gameState.currentPlayerIndex = data.nextArtistIndex;
                gameState.currentRound = data.currentRound;
                updatePlayersDisplay();
                
                if (data.gameOver) {
                    endGame();
                } else {
                    addSystemMessage(`الجولة التالية ستبدأ قريباً...`);
                    setTimeout(() => {
                        gameState.socket.emit('startNextRound', { roomId: gameState.roomId });
                    }, 3000);
                }
            });
            
            gameState.socket.on('gameOver', (data) => {
                gameState.players = data.players;
                endGame();
            });
            
            gameState.socket.on('disconnect', () => {
                alert('تم قطع الاتصال بالخادم. يرجى إعادة تحميل الصفحة.');
            });
        }

        // تحديث قائمة اللاعبين في غرفة الانتظار
        function updateWaitingPlayersList(players) {
            const waitingPlayersList = document.getElementById('waitingPlayersList');
            waitingPlayersList.innerHTML = '';
            
            players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                playerItem.innerHTML = `
                    <span>${player.name} ${player.isHost ? '👑' : ''}</span>
                `;
                waitingPlayersList.appendChild(playerItem);
            });
        }

        // الانضمام إلى غرفة عامة
        function joinPublicRoom(roomId) {
            const playerName = document.getElementById('privatePlayerName').value.trim();
            
            if (!playerName) {
                alert('يرجى إدخال اسمك أولاً في تبويب الغرف الخاصة');
                return;
            }
            
            if (!gameState.socket) {
                connectToServer();
            }
            
            gameState.socket.emit('joinPublicRoom', {
                roomId,
                playerName
            });
        }

        // بدء اللعبة من غرفة الانتظار
        function startGameFromWaitingRoom() {
            if (gameState.socket && gameState.isHost) {
                gameState.socket.emit('startGame', { roomId: gameState.roomId });
            }
        }

        // نسخ كود الغرفة
        function copyRoomCode() {
            const roomCode = document.getElementById('roomCodeDisplay')?.textContent || 
                             document.getElementById('gameRoomCode')?.textContent;
            
            if (roomCode) {
                navigator.clipboard.writeText(roomCode);
                alert('تم نسخ كود الغرفة: ' + roomCode);
            }
        }

        // مشاركة كود الغرفة
        function shareRoomCode() {
            const roomCode = document.getElementById('roomCodeDisplay')?.textContent || 
                             document.getElementById('gameRoomCode')?.textContent;
            
            if (roomCode && navigator.share) {
                navigator.share({
                    title: 'انضم إلى لعبة ارسم وخمن!',
                    text: `انضم إلى غرفتي في لعبة ارسم وخمن باستخدام الكود: ${roomCode}`,
                    url: window.location.href
                }).catch(err => {
                    console.log('Error sharing:', err);
                });
            } else if (roomCode) {
                // Fallback for browsers that don't support Web Share API
                copyRoomCode();
            }
        }

        // العودة إلى اختيار الغرفة
        function backToRoomSelection() {
            if (gameState.socket) {
                gameState.socket.emit('leaveRoom');
                gameState.socket.disconnect();
                gameState.socket = null;
            }
            
            document.getElementById('joinPrivateScreen').style.display = 'none';
            document.getElementById('roomScreen').style.display = 'block';
        }

        // بدء جولة جديدة
        function startNewRound() {
            gameState.timeLeft = 60;
            gameState.roundActive = true;
            
            clearCanvas();
            updateCurrentPlayerDisplay();
            updateWordDisplay();
            startTimer();
            
            // إظهار أدوات الرسم فقط للرسام الحالي
            const drawingTools = document.getElementById('drawingTools');
            drawingTools.style.display = isCurrentArtist() ? 'flex' : 'none';
            
            addSystemMessage(`بدأت جولة جديدة! ${gameState.players[gameState.currentPlayerIndex].name} يرسم الآن`);
        }

        // تحديث عرض اللاعب الحالي
        function updateCurrentPlayerDisplay() {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            document.getElementById('currentPlayerText').textContent = `الرسام الحالي: ${currentPlayer.name}`;
            document.getElementById('currentRound').textContent = gameState.currentRound;
        }

        // تحديث عرض الكلمة
        function updateWordDisplay() {
            const wordDisplay = document.getElementById('wordDisplay');
            if (isCurrentArtist()) {
                wordDisplay.textContent = `🎯 ارسم: ${gameState.currentWord}`;
                wordDisplay.style.background = '#e8f5e8';
            } else {
                wordDisplay.textContent = `🤔 خمن ما يرسمه ${gameState.players[gameState.currentPlayerIndex].name}`;
                wordDisplay.style.background = '#f0f8ff';
            }
        }

        // تحديث عرض اللاعبين
        function updatePlayersDisplay() {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';

            gameState.players.forEach((player, index) => {
                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${index === gameState.currentPlayerIndex ? 'current' : ''} ${player.isDrawing ? 'drawing' : ''}`;
                
                playerItem.innerHTML = `
                    <span>${player.name} ${index === gameState.currentPlayerIndex ? '🎨' : ''} ${player.isHost ? '👑' : ''}</span>
                    <span class="player-score">${player.score}</span>
                `;
                
                playersList.appendChild(playerItem);
            });
        }

        // بدء المؤقت
        function startTimer() {
            clearInterval(gameState.timer);
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer').textContent = gameState.timeLeft;

                if (gameState.timeLeft <= 0) {
                    endRound(false);
                }
            }, 1000);
        }

        // التخمين
        function makeGuess() {
            const guessInput = document.getElementById('guessInput');
            const guess = guessInput.value.trim();

            if (!guess || !gameState.roundActive || isCurrentArtist()) return;

            // إرسال التخمين إلى الخادم
            if (gameState.socket) {
                gameState.socket.emit('makeGuess', {
                    roomId: gameState.roomId,
                    guess: guess
                });
            }

            guessInput.value = '';
        }

        // إضافة رسالة للشات
        function addMessage(text, type, playerName = '') {
            const chatMessages = document.getElementById('chatMessages');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            
            if (playerName && type === 'guess') {
                message.textContent = `${playerName}: ${text}`;
            } else {
                message.textContent = text;
            }
            
            chatMessages.appendChild(message);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // تشغيل صوت الإشعار للرسائل المهمة
            if (type === 'correct' || type === 'system') {
                notificationSound.currentTime = 0;
                notificationSound.play();
            }
        }

        // إضافة رسالة نظام
        function addSystemMessage(text) {
            addMessage(text, 'system');
        }

        // نهاية الجولة
        function endRound(wasGuessed) {
            gameState.roundActive = false;
            clearInterval(gameState.timer);

            if (!wasGuessed) {
                addSystemMessage(`انتهى الوقت! الكلمة كانت: ${gameState.currentWord}`);
            }
        }

        // نهاية اللعبة
        function endGame() {
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'block';

            // ترتيب اللاعبين حسب النقاط
            const sortedPlayers = [...gameState.players].sort((a, b) => b.score - a.score);
            
            document.getElementById('winnerText').textContent = `🏆 الفائز: ${sortedPlayers[0].name}`;
            
            const finalScores = document.getElementById('finalScores');
            finalScores.innerHTML = '<h3>النتائج النهائية:</h3>';
            
            sortedPlayers.forEach((player, index) => {
                const position = index + 1;
                const medal = position === 1 ? '🥇' : position === 2 ? '🥈' : position === 3 ? '🥉' : `${position}.`;
                finalScores.innerHTML += `<p>${medal} ${player.name}: ${player.score} نقطة</p>`;
            });
            
            // تشغيل صوت الفوز
            correctSound.currentTime = 0;
            correctSound.play();
        }

        // العودة إلى اللوبي
        function returnToLobby() {
            if (gameState.socket) {
                gameState.socket.emit('leaveRoom');
                gameState.socket.disconnect();
                gameState.socket = null;
            }
            
            // إعادة تعيين حالة اللعبة
            gameState.players = [];
            gameState.currentPlayerIndex = 0;
            gameState.currentRound = 1;
            gameState.totalRounds = 5;
            gameState.timeLeft = 60;
            gameState.currentWord = '';
            gameState.gameStarted = false;
            gameState.roundActive = false;
            gameState.roomId = '';
            gameState.roomName = '';
            gameState.isPrivate = false;
            gameState.isHost = false;
            clearInterval(gameState.timer);

            // إعادة تعيين الواجهة
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('roomScreen').style.display = 'block';
            
            // مسح الشات واللوحة
            document.getElementById('chatMessages').innerHTML = '';
            clearCanvas();
        }

        // تغيير لغة الواجهة
        function changeLanguage(lang) {
            gameState.language = lang;
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.language-btn[onclick="changeLanguage('${lang}')"]`).classList.add('active');
            
            if (lang === 'en') {
                // تغيير الواجهة إلى الإنجليزية
                document.documentElement.lang = 'en';
                document.documentElement.dir = 'ltr';
                document.title = 'Draw & Guess - Online Drawing Game';
                // يمكنك إضافة المزيد من التغييرات هنا
            } else {
                // تغيير الواجهة إلى العربية
                document.documentElement.lang = 'ar';
                document.documentElement.dir = 'rtl';
                document.title = 'ارسم وخمن - لعبة الرسم والتخمين أونلاين';
                // يمكنك إضافة المزيد من التغييرات هنا
            }
        }

        // إعداد أولي
        setupCanvas();

        // التعامل مع Enter في حقل التخمين
        document.getElementById('guessInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                makeGuess();
            }
        });

        // التعامل مع Enter في حقول الإدخال
        document.getElementById('privatePlayerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                createPrivateRoom();
            }
        });
        
        document.getElementById('joinPlayerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinPrivateRoom();
            }
        });
        
        document.getElementById('privateRoomName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                createPrivateRoom();
            }
        });
        
        document.getElementById('roomCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinPrivateRoom();
            }
        });

        // عرض شاشة الانضمام إلى غرفة خاصة عند النقر على رابط
        function showJoinPrivateScreen() {
            document.getElementById('roomScreen').style.display = 'none';
            document.getElementById('joinPrivateScreen').style.display = 'block';
        }
    </script>
</body>
</html>
